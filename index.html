<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Points Todoist</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0f172a;
      --surface:  #1e293b;
      --surface2: #263448;
      --border:   rgba(148, 163, 184, 0.12);
      --accent:   #818cf8;
      --accent2:  #38bdf8;
      --success:  #4ade80;
      --warn:     #fbbf24;
      --danger:   #f87171;
      --text:     #f1f5f9;
      --muted:    #94a3b8;
      --r:        14px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      min-height: 100vh;
      padding: 16px 16px 40px;
      max-width: 720px;
      margin: 0 auto;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      text-align: center;
      padding: 24px 0 28px;
    }
    header h1 {
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    header .date {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 6px;
      text-transform: capitalize;
    }
    header .last-update {
      font-size: 0.72rem;
      color: var(--muted);
      opacity: 0.5;
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ KPI cards ‚îÄ‚îÄ */
    .kpis {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    @media (min-width: 560px) {
      .kpis { grid-template-columns: repeat(4, 1fr); }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .card .label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-weight: 600;
    }
    .card .value {
      font-size: 2.2rem;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.04em;
    }
    .card .sub {
      font-size: 0.76rem;
      color: var(--muted);
    }

    .card.c-accent  { border-color: rgba(129,140,248,0.25); }
    .card.c-accent  .value { color: var(--accent); }
    .card.c-warn    { border-color: rgba(251,191,36,0.25); }
    .card.c-warn    .value { color: var(--warn); }
    .card.c-success { border-color: rgba(74,222,128,0.25); }
    .card.c-success .value { color: var(--success); }
    .card.c-muted   .value { color: var(--muted); }

    /* ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ */
    .progress-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 16px 18px;
      margin-bottom: 12px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .progress-header .prog-label {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .progress-header .prog-pct {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text);
    }
    .progress-track {
      background: var(--surface2);
      border-radius: 99px;
      height: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 99px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      width: 0%;
      transition: width 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .progress-fill.done {
      background: linear-gradient(90deg, var(--success), #86efac);
    }

    /* ‚îÄ‚îÄ Chart ‚îÄ‚îÄ */
    .chart-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 18px 18px 14px;
      margin-bottom: 12px;
    }
    .chart-title {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .chart-wrap {
      position: relative;
      height: 190px;
    }

    /* ‚îÄ‚îÄ Timing section ‚îÄ‚îÄ */
    .timing-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 18px 18px 16px;
      margin-bottom: 12px;
    }
    .timing-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .timing-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-weight: 600;
    }
    .timing-delta {
      font-size: 0.78rem;
      font-weight: 700;
      border-radius: 99px;
      padding: 2px 10px;
    }
    .timing-delta.faster {
      background: rgba(74,222,128,0.12);
      color: var(--success);
    }
    .timing-delta.slower {
      background: rgba(248,113,113,0.12);
      color: var(--danger);
    }
    .timing-delta.same {
      background: rgba(148,163,184,0.1);
      color: var(--muted);
    }
    .timing-main {
      font-size: 3rem;
      font-weight: 800;
      letter-spacing: -0.05em;
      line-height: 1;
      color: var(--success);
      margin-bottom: 6px;
    }
    .timing-main.in-progress {
      color: var(--warn);
      font-size: 2rem;
    }
    .timing-sub {
      font-size: 0.76rem;
      color: var(--muted);
    }

    /* ‚îÄ‚îÄ Leaderboard ‚îÄ‚îÄ */
    .lb-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 18px 18px 14px;
      margin-bottom: 12px;
    }
    .lb-title {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-weight: 600;
      margin-bottom: 14px;
    }
    .lb-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .lb-row:last-child { border-bottom: none; }
    .lb-rank {
      font-size: 1rem;
      width: 28px;
      text-align: center;
      flex-shrink: 0;
    }
    .lb-date {
      flex: 1;
      font-size: 0.82rem;
      color: var(--muted);
    }
    .lb-time {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }
    .lb-row.today .lb-date { color: var(--text); font-weight: 600; }
    .lb-row.today .lb-time { color: var(--success); }

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    #loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      padding: 80px 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .spinner {
      width: 30px; height: 30px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
    .error-box {
      background: rgba(248,113,113,0.08);
      border: 1px solid rgba(248,113,113,0.3);
      color: var(--danger);
      border-radius: var(--r);
      padding: 16px;
      text-align: center;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    /* ‚îÄ‚îÄ Refresh button ‚îÄ‚îÄ */
    .refresh-row {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .btn-refresh {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 99px;
      padding: 8px 18px;
      font-size: 0.78rem;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }
    .btn-refresh:hover {
      color: var(--text);
      border-color: rgba(148,163,184,0.3);
    }

    #app { display: none; }
    #app.visible { display: block; }
    #error { display: none; }
  </style>
</head>
<body>

<header>
  <h1>Points Todoist</h1>
  <div class="date" id="date-display"></div>
  <div class="last-update" id="last-update"></div>
</header>

<div id="loading">
  <div class="spinner"></div>
  <span>Chargement‚Ä¶</span>
</div>

<div id="error"></div>

<div id="app">
  <div class="kpis">
    <div class="card c-accent" id="card-earned">
      <div class="label">Pts gagn√©s</div>
      <div class="value" id="kpi-earned">‚Äî</div>
      <div class="sub">aujourd'hui</div>
    </div>
    <div class="card c-warn" id="card-remaining">
      <div class="label">Restants</div>
      <div class="value" id="kpi-remaining">‚Äî</div>
      <div class="sub">pour l'objectif</div>
    </div>
    <div class="card c-muted">
      <div class="label">Objectif</div>
      <div class="value" id="kpi-goal">‚Äî</div>
      <div class="sub">pts / jour</div>
    </div>
    <div class="card c-muted">
      <div class="label">Cette semaine</div>
      <div class="value" id="kpi-week">‚Äî</div>
      <div class="sub" id="kpi-week-sub">objectifs atteints</div>
    </div>
  </div>

  <div class="progress-section">
    <div class="progress-header">
      <span class="prog-label">Progression du jour</span>
      <span class="prog-pct" id="prog-pct">0%</span>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="prog-fill"></div>
    </div>
  </div>

  <div class="chart-section">
    <div class="chart-title">7 derniers jours</div>
    <div class="chart-wrap">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <!-- Timing section -->
  <div class="timing-section" id="timing-section" style="display:none">
    <div class="timing-header">
      <span class="timing-label">‚è± Objectif atteint √†</span>
      <span class="timing-delta" id="timing-delta"></span>
    </div>
    <div class="timing-main" id="timing-main">‚Äî</div>
    <div class="timing-sub" id="timing-sub"></div>
  </div>

  <!-- Leaderboard section -->
  <div class="lb-section" id="lb-section" style="display:none">
    <div class="lb-title">üèÜ Meilleurs temps</div>
    <div id="lb-list"></div>
  </div>

  <div class="refresh-row">
    <button class="btn-refresh" onclick="load()">Actualiser</button>
  </div>
</div>

<script>
let chartInstance = null;

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRsKUIpN6X6wkA2QhvrJ10pP-WsmMCkma5xQsZSpVBurWvnEPa3mLfwPOfMSw86gZIrg/exec';

async function load() {
  showLoading(true);
  try {
    const data = await fetchWithFallback();
    render(data);
  } catch (err) {
    showError(err.message);
  }
}

async function fetchWithFallback() {
  const proxies = [
    {
      url: 'https://api.allorigins.win/raw?url=' + encodeURIComponent(SCRIPT_URL),
      parse: async (res) => res.json()
    },
    {
      url: 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(SCRIPT_URL),
      parse: async (res) => res.json()
    },
    {
      url: 'https://api.allorigins.win/get?url=' + encodeURIComponent(SCRIPT_URL),
      parse: async (res) => { const w = await res.json(); return JSON.parse(w.contents); }
    }
  ];

  let lastError;
  for (const proxy of proxies) {
    try {
      const res = await fetch(proxy.url, { signal: AbortSignal.timeout(9000) });
      if (!res.ok) throw new Error('Erreur r√©seau ' + res.status);
      return await proxy.parse(res);
    } catch (err) {
      lastError = err;
    }
  }
  throw lastError;
}

function render({ today, weekData, leaderboard, fetchedAt }) {
  showLoading(false);
  document.getElementById('app').classList.add('visible');
  document.getElementById('error').style.display = 'none';

  // Header
  const now = new Date();
  document.getElementById('date-display').textContent = now.toLocaleDateString('fr-FR', {
    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
  });
  if (fetchedAt) {
    const ft = new Date(fetchedAt);
    document.getElementById('last-update').textContent =
      `Mis √† jour √† ${ft.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
  }

  // KPIs
  const earned    = today.earned    ?? 0;
  const goal      = today.goal      || 30;
  const remaining = today.remaining ?? 0;
  const weekTotal = today.weekTotal ?? 0;
  const goalsHit  = today.weekGoalsHit ?? 0;

  document.getElementById('kpi-earned').textContent    = earned;
  document.getElementById('kpi-goal').textContent      = goal;
  document.getElementById('kpi-week').textContent      = weekTotal;
  document.getElementById('kpi-week-sub').textContent  = `${goalsHit}/7 objectifs`;

  // Remaining card ‚Äî vert si objectif atteint
  const remEl      = document.getElementById('kpi-remaining');
  const cardRem    = document.getElementById('card-remaining');
  if (remaining <= 0) {
    remEl.textContent   = '0 ‚úì';
    cardRem.className   = 'card c-success';
  } else {
    remEl.textContent   = remaining;
    cardRem.className   = 'card c-warn';
  }

  // Progress bar
  const pct = Math.min(100, Math.round((earned / goal) * 100));
  document.getElementById('prog-pct').textContent = `${pct}%`;
  requestAnimationFrame(() => {
    const fill = document.getElementById('prog-fill');
    fill.style.width = `${pct}%`;
    fill.classList.toggle('done', pct >= 100);
  });

  // Chart
  renderChart(weekData, goal);

  // Timing + Leaderboard
  updateTimingUI(leaderboard || []);
}

// ‚îÄ‚îÄ Timing helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function timeToMinutes(t) {
  if (!t || typeof t !== 'string') return null;
  const parts = t.split(':');
  if (parts.length < 2) return null;
  const h = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10);
  if (isNaN(h) || isNaN(m)) return null;
  return h * 60 + m;
}

function minutesToDisplay(mins) {
  if (mins === null || mins === undefined) return '‚Äî';
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

function formatDelta(todayMins, prevMins) {
  if (prevMins === null || prevMins === undefined) return null;
  const diff = todayMins - prevMins; // negative = faster
  const abs = Math.abs(diff);
  const h = Math.floor(abs / 60);
  const m = abs % 60;
  const str = h > 0 ? `${h}h${String(m).padStart(2, '0')}` : `${m} min`;
  if (diff < 0) return { text: `‚ñ≤ ${str} plus t√¥t`, cls: 'faster' };
  if (diff > 0) return { text: `‚ñº ${str} plus tard`, cls: 'slower' };
  return { text: `= m√™me heure`, cls: 'same' };
}

function updateTimingUI(leaderboard) {
  const timingSection = document.getElementById('timing-section');
  const lbSection     = document.getElementById('lb-section');

  if (!leaderboard || leaderboard.length === 0) return;

  // Today's date in YYYY-MM-DD
  const todayStr = new Date().toLocaleDateString('sv-SE'); // sv-SE gives ISO format

  // Find today's entry
  const todayEntry = leaderboard.find(e => e.date === todayStr);

  // Show timing section
  timingSection.style.display = 'block';
  const mainEl  = document.getElementById('timing-main');
  const subEl   = document.getElementById('timing-sub');
  const deltaEl = document.getElementById('timing-delta');

  if (todayEntry && todayEntry.goalTime) {
    // Goal already reached today
    mainEl.textContent = todayEntry.goalTime;
    mainEl.className   = 'timing-main';
    subEl.textContent  = `Objectif atteint (${todayEntry.total} pts)`;

    // Compare with yesterday
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yStr = yesterday.toLocaleDateString('sv-SE');
    const yEntry = leaderboard.find(e => e.date === yStr);

    if (yEntry && yEntry.goalTime) {
      const todayMins = timeToMinutes(todayEntry.goalTime);
      const yMins     = timeToMinutes(yEntry.goalTime);
      const delta = formatDelta(todayMins, yMins);
      if (delta) {
        deltaEl.textContent = delta.text;
        deltaEl.className   = `timing-delta ${delta.cls}`;
      }
    } else {
      deltaEl.textContent = '';
      deltaEl.className   = 'timing-delta';
    }
  } else {
    // Goal not reached yet today
    mainEl.textContent = 'En cours‚Ä¶';
    mainEl.className   = 'timing-main in-progress';
    subEl.textContent  = todayEntry
      ? `${todayEntry.total} pts accumul√©s aujourd'hui`
      : 'Pas encore de points aujourd\'hui';
    deltaEl.textContent = '';
    deltaEl.className   = 'timing-delta';
  }

  // Leaderboard ‚Äî top 10 days with a goalTime, sorted by earliest time
  const ranked = leaderboard
    .filter(e => e.goalTime)
    .sort((a, b) => {
      const am = timeToMinutes(a.goalTime);
      const bm = timeToMinutes(b.goalTime);
      return am - bm;
    })
    .slice(0, 10);

  if (ranked.length === 0) return;

  lbSection.style.display = 'block';
  const medals = ['ü•á', 'ü•à', 'ü•â'];
  const listEl = document.getElementById('lb-list');
  listEl.innerHTML = '';

  ranked.forEach((entry, idx) => {
    const isToday = entry.date === todayStr;
    const row = document.createElement('div');
    row.className = 'lb-row' + (isToday ? ' today' : '');

    // Format date as DD/MM
    const d = entry.date.split('-');
    const dateLabel = isToday
      ? `Aujourd'hui (${d[2]}/${d[1]})`
      : `${d[2]}/${d[1]}/${d[0]}`;

    row.innerHTML = `
      <span class="lb-rank">${medals[idx] || idx + 1}</span>
      <span class="lb-date">${dateLabel}</span>
      <span class="lb-time">${entry.goalTime}</span>
    `;
    listEl.appendChild(row);
  });
}

function renderChart(weekData, goal) {
  const labels = weekData.map(d =>
    d.day.charAt(0).toUpperCase() + d.day.slice(1, 3)
  );
  const values = weekData.map(d => d.points);

  const barColors = values.map(v =>
    v >= goal ? 'rgba(74,222,128,0.85)' :
    v > 0     ? 'rgba(129,140,248,0.85)' :
                'rgba(38,52,72,0.9)'
  );

  if (chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('chart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          type: 'bar',
          data: values,
          backgroundColor: barColors,
          borderRadius: 7,
          borderSkipped: false,
          order: 2,
        },
        {
          type: 'line',
          data: new Array(values.length).fill(goal),
          borderColor: 'rgba(251,191,36,0.45)',
          borderDash: [5, 4],
          borderWidth: 1.5,
          pointRadius: 0,
          fill: false,
          order: 1,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          filter: (item) => item.datasetIndex === 0,
          callbacks: {
            title: (items) => {
              const i = items[0].dataIndex;
              return weekData[i] ? `${weekData[i].day} ${weekData[i].date}` : labels[i];
            },
            label: (item) => ` ${item.raw} pts`,
          },
          backgroundColor: '#1e293b',
          borderColor: 'rgba(148,163,184,0.15)',
          borderWidth: 1,
          titleColor: '#f1f5f9',
          bodyColor: '#94a3b8',
          padding: 10,
          cornerRadius: 8,
        }
      },
      scales: {
        x: {
          grid: { display: false },
          border: { display: false },
          ticks: { color: '#64748b', font: { size: 11 } },
        },
        y: {
          grid: { color: 'rgba(148,163,184,0.05)', drawTicks: false },
          border: { display: false },
          ticks: { color: '#64748b', font: { size: 11 }, padding: 8 },
          suggestedMax: Math.max(goal * 1.15, Math.max(...values, 1) * 1.15),
          beginAtZero: true,
        }
      }
    }
  });
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

function showError(msg) {
  showLoading(false);
  const el = document.getElementById('error');
  el.style.display = 'block';
  el.innerHTML = `<div class="error-box">Impossible de charger les donn√©es.<br><small style="opacity:.7">${msg}</small></div>`;
}

// Chargement initial + refresh auto toutes les 5 min
load();
setInterval(load, 5 * 60 * 1000);
</script>
</body>
</html>
